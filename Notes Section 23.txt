23-512. Creating a GitHub Action ~ 513. Adding a CI Test Script
https://docs.github.com/en/github-ae@latest/actions/using-workflows/events-that-trigger-workflows

### Github => Choose Repository => Actions => Yourself
https://github.com/christseng89/Microservices-with-Node-JS-and-React/new/master?filename=.github%2Fworkflows%2Fmain.yml&workflow_template=blank

// tests.yaml
name: tests

on: pull_request

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: cd auth && npm install && npm run test:ci

### Auth
// package.json
    "test": "jest --runInBand --detectOpenHandles --watchAll --no-cache",
    "test:ci": "jest" ***

git add .
git commit -am "23-512. Creating a GitHub Action ~ 513. Adding a CI Test Script"
git pull
git push

23-514. Running Tests on PR Creation
### Auth
index.ts
const start = async () => {
  console.log('Starting up ...'); ***
  if (!process.env.JWT_KEY) {

// Create a Branch
git checkout -b dev
  Switched to a new branch 'dev'    

git commit -am "23-514. Running Tests on PR Creation #1"
git push origin dev

// tests.yaml
      - run: cd ticketing && cd auth && npm install && npm run test:ci ***
git push origin dev

### Github => Pull Requests => New Pull Request => master <- dev

23-515. Output of Failing Tests
// signin.test.ts
it('responds with a cookie when given valid credentials', async () => {
  const cookie = await global.signup();
  const response = await request(app)
    .post('/api/users/signin')
    .send({
      email: 'test@test.com',
      password: 'password'
    })
    .expect(400); ***

git commit -am "23-515. Output of Failing Tests #1"
git push origin dev

// signin.test.ts
it('responds with a cookie when given valid credentials', async () => {
  const cookie = await global.signup();
  const response = await request(app)
    .post('/api/users/signin')
    .send({
      email: 'test@test.com',
      password: 'password'
    })
    .expect(200); ***

git commit -am "23-515. Output of Failing Tests #2"
git push origin dev

### Manually create a PR (Pull Request) once.  CI will run automatically.

23-516. Running Tests in Parallel
// package.json (tickets, orders, payments)
    "test:ci": "jest" ***

// package.json (expiration)
  "scripts": {
    "start": "ts-node-dev src/index.ts"
  },

git commit -am "23-516. Running Tests in Parallel #1"
git push origin dev

### .github\workflows
ren tests.yaml => tests-auth.yaml
// tests-tickets.yaml, tests-orders.yaml, tests-payments.yaml (new)

git add .
git commit -am "23-516. Running Tests in Parallel #2"
git push origin dev

### Add stripe-key.ts (temporary)
git add .
git commit -am "23-516. Running Tests in Parallel #3"
git push origin dev

### PULL REQUEST by using CLI
git branch
  * dev
    master

git push origin dev:master
git switch master
git branch
    dev
  * master
git pull

23-518. Selective Test Execution
git switch dev
git branch
git pull origin master

### Revise tests-xxxx.yaml
on:
  pull_request:
    paths:
      - 'ticketing/xxxx/**'

git add .
git commit -am "23-518. Selective Test Execution"
git push origin dev
### Merge dev => master
git push origin dev:master
git pull origin master

### Payments
index.ts
const start = async () => {
  console.log('Starting up ...');  ***

git commit -am "23-518. Selective Test Execution #2"
git push origin dev
git switch master
git merge dev master
git push origin dev:master

https://github.com/christseng89/Microservices-with-Node-JS-and-React/settings/branches
  v Require a pull request before merging

git commit -am "23-518. Selective #3"
git push origin dev
git merge dev master  

git commit -am "23-518. Selective #4"
git push origin dev
git merge dev master  

https://github.com/christseng89/Microservices-with-Node-JS-and-React/settings/branches
  x Require a pull request before merging

git commit -am "23-518. Selective #5"
git push origin dev

### Delete branch
git switch master
git pull
git branch -d dev
  Deleted branch dev (was 5a8a3b1).
git branch
    JeffWang
  * master  

// update auth\index.ts
git commit -am "23-518. Selective #6"
git push origin master

### Test #7
https://github.com/christseng89/Microservices-with-Node-JS-and-React/settings/branches
  v Require a pull request before merging

// update auth\index.ts
git commit -am "23-518. Selective #7"
git push origin master

### Test #8
git checkout dev
git branch
  * dev
    master

// update auth\index.ts
git commit -am "23-518. Selective #8"
git push origin dev

// Delete branch from Github
git switch master
git pull
git branch -d dev
git push origin --delete dev

### Retry 514. Running Tests on PR Creation ~ 518. Selective Test Execution
use branch chris instead of dev
git checkout -b chris
git push origin chris
git switch chris

auth\index.ts

git status
  modified:   Notes Section 23.txt
  modified:   ticketing/auth/src/index.ts

git commit -am "23-514. Running Tests on PR Creation *1"
git push origin chris

### Github => Pull requests => New pull request => base:master <- compare:chris =>
    Pull Request chris to master => Create pull request
    ...
    All checks have passed => Merge pull request

auth\index.ts
git commit -am "23-514. Running Tests on PR Creation *2"
git push origin chris

### Github (PR => Pull Request chris to master)
  @christseng89   23-514. Running Tests on PR Creation *1   003012d
  @christseng89   23-514. Running Tests on PR Creation *2   00f8511
    ...
    All checks have passed => Merge pull request => Confirm merge

git add .
git commit -am "23-514. Running Tests on PR Creation *3"
git push origin chris

auth\index.ts
git commit -am "23-514. Running Tests on PR Creation *4"
git push origin chris

auth\index.ts
git commit -am "23-514. Running Tests on PR Creation *5"
git push origin chris

### Github => Merge PR => Confirm merge
git switch master
git pull
.github\workflows

tests-auth.yml, tests-tickets.yml, tests-orders.yml, tests-payments.yml

// package.json
    "test:ci": "jest" ***

git add .
git commit -am "23-514. Running Tests on PR Creation *6(master)"
git push origin master

// 517. Verifying a Test Run
git checkout chris
git merge master

### Payments
// stripe-key.ts
export const stripeKey = 'sk_test_mock';

### Skip stripe for a Faked Stripe Key ...
// new.ts
  let charge = { id: "fake-stripe-id" }; ***
  if (process.env.STRIPE_KEY?.length === 42) {
    const amount = Math.round(order.price * 100);
    // Charge the customer
    charge = await stripe.charges.create({
      currency: 'usd',
      amount,
      source: token,
      description: 'Charge for order #' + order.id
    });
  }

// new.test.ts
...
let stripeTest = false;
let stripeTestDescription = "returns a 201 with valid inputs"
if (process.env.STRIPE_KEY?.length === 42) {
  stripeTest = true;
  stripeTestDescription = stripeTestDescription + " real Stripe Test"
} else {
  stripeTestDescription = stripeTestDescription + " fake Stripe Test"
}
...
it(stripeTestDescription, async () => { ***
  ...
  let returnCharge: Stripe.Charge | undefined;
  if (stripeTest) { ***
    // REAL STRIPE TEST LIST
    const stripeCharges = await stripe.charges.list({ limit: 10, });
    const stripeCharge = stripeCharges['data'].find((charge) => {
      return charge.amount === price * 100;
    });
    
    returnCharge = stripeCharge;
    expect(stripeCharge).toBeDefined();
    expect(stripeCharge!.currency).toEqual('usd');
    expect(stripeCharge!.amount).toEqual(price * 100); 

    // Check payment ....
    const payment = await Payment.findOne({
      orderId: order.id,
      stripeId: returnCharge!.id,
    });
    expect(payment).not.toBeNull();  
    expect(payment!.orderId).toEqual(order.id);
    expect(payment!.stripeId).toEqual(returnCharge!.id);
  }

  ...
});

cd ticketing\payments
npm run test
npm run test:ci

### Push to git branch chris
cd ..\..\
git add .
git commit -am "23-517. Verifying a Test Run"
git push origin chris

### Github PR (New pull request => Pull Request chris to master) => Merge PR => Confirm merge

23-519. Deployment Options
// Digital Ocean (samfire5202@gmail.com)
https://cloud.digitalocean.com/projects?i=bc31ee

22-520. Creating a Hosted Cluster
= Create => Kubernetes => datacenter region (Singapore) => 
  Name* (ticketing-cluster) => Create Cluster

22-520. Creating a Hosted Cluster
2 => Connecting to Kubernetes
https://docs.digitalocean.com/reference/doctl/how-to/install/
choco install doctl

22-521. Reminder on Kubernetes Context
https://cloud.digitalocean.com/account/api/tokens?i=bc31ee
API => Generate New Token (doctl) => Generate Token

doctl auth init
  Enter your access token: ***

22-522. Reminder on Swapping Contexts
https://docs.digitalocean.com/reference/doctl/how-to/install/
doctl auth list
doctl account get
  User Email               Team       Droplet Limit    Email Verified    User UUID                               Status
  samfire5202@gmail.com    My Team    10               true              3baa1487-fa1a-434f-9c0d-d30c2cd6bd74    active

doctl kubernetes cluster kubeconfig save ticketing-cluster
  Notice: Adding cluster credentials to kubeconfig file found in "C:\\Users\\Chris Tseng\\.kube\\config"
  Notice: Setting current-context to do-sgp1-ticketing-cluster

kubectl get po
  No resources found in default namespace.

kubectl get node
  NAME                   STATUS   ROLES    AGE   VERSION
  pool-s8nssup3j-czpw2   Ready    <none>   93m   v1.23.9
  pool-s8nssup3j-czpwl   Ready    <none>   94m   v1.23.9
  pool-s8nssup3j-czpwp   Ready    <none>   94m   v1.23.9

kubectl config view | grep cluster:
  - cluster:
      cluster: do-sgp1-ticketing-cluster

### PR changes
git add .
git commit -am "22-522. Reminder on Swapping Contexts"
git push origin chris

### Github (Pull Request chris to master) => Merge PR => Confirm merge

cd ticketing\payments\src
git update-index --assume-unchanged stripe-key.ts

git add .
git commit -am "22-522. Reminder on Swapping Contexts #2"
git push origin chris

### Github (Pull Request chris to master) => Merge PR => Confirm merge

23-524. Building an Image in an Action ~ 526. Restarting the Deployment
### Step #1 - master
git checkout ticketing/payments/src/stripe-key.ts
git switch master
git pull

// .github\workflows\deploy-auth.yml (new)

### Github => Settings => Secrets => Actions => New Repository Secret
DOCKER_USERNAME (christseng89) => Add secret
DOCKER_PASSWORD (tn2nn#Xxxxx) => Add secret
DIGITALOCEAN_ACCESS_TOKEN (***) => Add secret

git add .
git commit -am "23-524. Building an Image in an Action ~ 526. Restarting the Deployment #1"
git push origin master

### Step #2 - chris 
git checkout chris
git merge master

// auth\src\index.ts

git add .
git commit -am "23-524. Building an Image in an Action ~ 526. Restarting the Deployment #2"
git push origin chris

### Github (Pull Request chris to master) => Merge PR => Confirm merge

### Step #3 - master
// auth\src\index.ts

git commit -am "23-524. Building an Image in an Action ~ 526. Restarting the Deployment #3"
git push origin master

### Step #4 - chris 
git checkout chris
git merge master

// auth\src\index.ts

git add .
git commit -am "23-524. Building an Image in an Action ~ 526. Restarting the Deployment #4"
git push origin chris

### Github (Pull Request chris to master) => Merge PR => Confirm merge

git add .
git commit -am "525. Testing the Image Build"
git push origin chris

### Github (Pull Request chris to master) => Merge PR => Confirm merge
